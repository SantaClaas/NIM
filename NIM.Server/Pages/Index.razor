@page "/"
@page "/index"
@using Models
@inject NavigationManager navigationManager
@inject GameState gameState
@if (gameState.IsInitialized && gameState.Game.State == NIM.GameState.GameOver)
{
    <div class="alert alert-success">
        Congratulations @(string.Join(',', gameState.Game.GetWinningPlayers().Select(p => p.Name))) you won!
    </div>
}

<div class="row justify-content-center">
    <h1>New Game</h1>
</div>

<div class="row justify-content-center">
    <div class="col col-lg-3 col-md-5 col-sm-10 justify-content-center">
        <form>
            @for (int i = 0; i < PossiblePlayers.Count; ++i)
            {
                int index = i;
                <div class="form-group">
                    <label for="playerName @index">@($"Player {index + 1}"):</label>
                    <input type="text" class="form-control" id="playerName @index" placeholder="@($"Player {index + 1}")" @bind="PossiblePlayers[index].Name" />
                    @if (index != 0)
                    {
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="checkIsAiPlayer @index" @bind="PossiblePlayers[index].IsAiPlayer" />
                            <label class="form-check-label" for="checkIsAiPlayer @index">Ai Player</label>
                        </div>
                    }
                    @if (PossiblePlayers[index].IsAiPlayer)
                    {
                        <div class="form-control-range form-row">
                            <div class="col-auto">
                                <label for="aiLevel @index">Difficulty:</label>
                            </div>
                            <div class="col-1">
                                <label>@PossiblePlayers[index].DifficultyAdvancedAi</label>
                            </div>
                            <div class="col-auto flex-fill">
                                <input type="range" class="custom-range" id="aiLevel @index" min="-1" max="1" step="0.1" @bind="PossiblePlayers[index].DifficultyAdvancedAi" @bind:event="oninput" />
                            </div>
                        </div>
                    }
                </div>
            }
        </form>
        <button class="btn btn-success" @onclick="AddNew">Add Player</button>
        <button class="btn btn-danger" @onclick="RemoveLatest">Remove Player</button>
        <button class="btn btn-primary" @onclick="@OnSubmit"><i class="oi oi-media-play" /> Start </button>
        <a href="/settings" class="btn btn-secondary active"><i class="oi oi-cog" /></a>
    </div>
</div>

@code{
    private List<Player> ValidAiPlayers { get; set; }

    private List<PlayerSelectorModel> PossiblePlayers { get; set; }

    protected override void OnInitialized()
    {
        ValidAiPlayers = new List<Player> {
        new AiPlayerFirst($"Computer First"),
        new AiPlayerRandom($"Computer Random"),
        new AiPlayerMinMax($"Computer Advanced",0) };

        PossiblePlayers = Enumerable.Range(0, 2).Select(i => new PlayerSelectorModel
        {
            Number = i,
            IsAiPlayer = false,
            //Name = $"Player {i + 1}",
            SelectedAiPlayer = null,
            DifficultyAdvancedAi = 0f
        })
        .ToList();
    }
    void OnAiPlayerChange(AiPlayerChangeArgs e)
    {
        if (int.TryParse(e.ChangeEventArgs.Value as string, out int i))
        {
            PossiblePlayers[e.ModelNumber].SelectedAiPlayer = ValidAiPlayers[i] switch
            {
                AiPlayerFirst first => new AiPlayerFirst($"Player {i} ({first.Name})"),
                AiPlayerRandom random => new AiPlayerRandom($"Player {i} ({random.Name})"),
                AiPlayerMinMax _ => new AiPlayerMinMax("Computer Advanced", PossiblePlayers[e.ModelNumber].DifficultyAdvancedAi),
                _ => new AiPlayerFirst("Computer")
            };
            this.StateHasChanged();
        }

    }

    void OnClick(int index)
    {
        PossiblePlayers[index].SelectedAiPlayer = new AiPlayerMinMax("Computer Advanced", PossiblePlayers[index].DifficultyAdvancedAi);

        this.StateHasChanged();
    }

    void OnLevelChange(AiPlayerChangeArgs e)
    {
        if (float.TryParse(e.ChangeEventArgs.Value as string, out float newLevel)
            && PossiblePlayers[e.ModelNumber].SelectedAiPlayer is AiPlayerMinMax advancedAiPlayer)
        {
            PossiblePlayers[e.ModelNumber].SelectedAiPlayer = new AiPlayerMinMax(advancedAiPlayer.Name, newLevel);
        }
    }

    void OnSubmit()
    {
        var players = PossiblePlayers.Select(p => p.IsAiPlayer ? p.SelectedAiPlayer : new Human(p.Name ?? $"Player {p.Number + 1}")).ToList();

        Rules rules = gameState.RulesBuilder?.Players(players.Count).Create() ?? Rules.Default;
        gameState.Game = new Game(rules, players);
        navigationManager.NavigateTo("nim");
        // get move
        gameState.Game.Step();
    }



    void AddNew()
    {

        PossiblePlayers.Add(new PlayerSelectorModel
        {

            Number = PossiblePlayers.Count,
            IsAiPlayer = false,
            //Name = $"Player {i + 1}",
            SelectedAiPlayer = null,
            DifficultyAdvancedAi = 0f,
        });
        this.StateHasChanged();


    }

    void RemoveLatest()
    {
        if (PossiblePlayers.Count == 2) return;
        PossiblePlayers.RemoveAt(PossiblePlayers.Count - 1);
        this.StateHasChanged();
    }

    void OnFocusOut(int i)
    {
        if (PossiblePlayers.Any(p => p.Name == PossiblePlayers[i].Name))
            PossiblePlayers[i].Name += $"(2)";
    }

}
